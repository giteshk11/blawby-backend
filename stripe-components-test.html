<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Stripe Components Test</title>
    <!-- Load Stripe.js -->
    <script src="https://js.stripe.com/v3/"></script>

    <!-- Load Stripe Connect via ES Module from CDN -->
    <script type="module">
      import { loadConnectAndInitialize } from 'https://cdn.jsdelivr.net/npm/@stripe/connect-js@3.3.30/+esm';

      // Make it globally available for our scripts
      window.loadConnectAndInitialize = loadConnectAndInitialize;
      window.stripeConnectReady = true;

      console.log('Stripe Connect loaded as ES module');
    </script>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
          Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #333;
      }
      .container {
        max-width: 1000px;
        margin: 0 auto;
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .section {
        margin-bottom: 30px;
        padding: 20px;
        border: 1px solid #e1e5e9;
        border-radius: 8px;
      }
      .section h2 {
        color: #4f46e5;
        margin-bottom: 15px;
      }
      .test-button {
        background: #4f46e5;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
        transition: background-color 0.2s;
      }
      .test-button:hover {
        background: #3730a3;
      }
      .status {
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
      }
      .success {
        background: #d1fae5;
      }
      .error {
        background: #fecaca;
      }
      .info {
        background: #dbeafe;
      }

      /* Stripe Elements styling */
      .StripeElement {
        background-color: white;
        height: 40px;
        padding: 10px 12px;
        border-radius: 4px;
        border: 1px solid transparent;
        box-shadow: 0 1px 3px 0 #e6ebf1;
        -webkit-transition: box-shadow 150ms ease;
        transition: box-shadow 150ms ease;
      }
      .StripeElement--focus {
        box-shadow: 0 1px 3px 0 #cfd7df;
      }
      .StripeElement--invalid {
        border-color: #fa755a;
      }
      .StripeElement--webkit-autofill {
        background-color: #fefde5 !important;
      }

      #card-element {
        margin: 10px 0;
      }

      .hidden {
        display: none;
      }

      .stripe-connect-container {
        min-height: 400px;
        border: 2px solid #e1e5e9;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
        background: #f9f9f9;
      }

      #connect-component {
        min-height: 300px;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 10px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Stripe Components Test</h1>

      <div class="section">
        <h2>Stripe Connect Account Onboarding</h2>
        <p>Test Stripe's Connect account onboarding component:</p>

        <button class="test-button" onclick="testServerConnection()">
          Test Server Connection
        </button>

        <button class="test-button" onclick="loadStripeConnect()">
          Load Stripe Connect Onboarding
        </button>

        <button class="test-button" onclick="refreshSession()">
          Refresh Session
        </button>

        <div id="connect-status" class="status info">Status: Ready to test</div>

        <div
          id="stripe-connect-container"
          class="stripe-connect-container hidden"
        >
          <h3>Stripe Connect Account Onboarding</h3>
          <div id="connect-component"></div>
        </div>
      </div>

      <div class="section">
        <h2>Test Results</h2>
        <div id="results"></div>
      </div>
    </div>

    <script>
      // Server configuration
      const SERVER_BASE_URL = 'http://localhost:3000';

      // Token management
      const DEFAULT_AUTH_TOKEN = 'IP8I3K4foOzbrBgx7ThcXGZVEJrbIoXD';
      let AUTH_TOKEN = localStorage.getItem('auth_token') || DEFAULT_AUTH_TOKEN;

      // Backend now handles all session management!
      // No need for client-side expiration checks

      // Initialize Stripe Connect only
      console.log(
        'loadConnectAndInitialize available:',
        typeof window.loadConnectAndInitialize !== 'undefined',
      );
      console.log(
        'Available Stripe globals:',
        Object.keys(window).filter(
          (k) => k.includes('Stripe') || k.includes('loadConnect'),
        ),
      );
      console.log('Stripe object keys:', Object.keys(Stripe || {}));
      console.log('Current auth token:', AUTH_TOKEN.substring(0, 20) + '...');

      // Test server connection
      async function testServerConnection() {
        const statusEl = document.getElementById('connect-status');
        statusEl.textContent = 'Testing server connection...';
        statusEl.className = 'status info';

        try {
          // Test basic server health
          const healthResponse = await fetch(`${SERVER_BASE_URL}/api/health`);
          console.log('Health check response:', healthResponse.status);

          statusEl.textContent = `Server is running! Health check: ${healthResponse.status}`;
          statusEl.className = 'status success';
        } catch (error) {
          statusEl.textContent = 'Server connection failed: ' + error.message;
          statusEl.className = 'status error';
          console.error('Server test error:', error);
        }
      }

      // Load Stripe Connect component - backend handles session management
      async function loadStripeConnect() {
        const statusEl = document.getElementById('connect-status');
        const containerEl = document.getElementById('stripe-connect-container');
        const componentEl = document.getElementById('connect-component');

        statusEl.textContent = 'Creating/getting connected account...';
        statusEl.className = 'status info';

        try {
          // Call backend - it handles all session logic
          const accountResponse = await fetch(
            `${SERVER_BASE_URL}/api/onboarding/connected-accounts`,
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${AUTH_TOKEN}`,
              },
              body: JSON.stringify({
                email: 'test@example.com',
                country: 'US',
              }),
            },
          );

          if (!accountResponse.ok) {
            const errorText = await accountResponse.text();
            throw new Error(
              `Account creation failed: ${accountResponse.status} ${accountResponse.statusText}. Response: ${errorText}`,
            );
          }

          const accountData = await accountResponse.json();
          console.log('Account data:', accountData);

          let clientSecret;

          // Backend tells us what to do based on sessionStatus
          if (accountData.sessionStatus === 'expired') {
            console.log('Session expired, calling refresh API...');

            // Backend told us to refresh - call session API
            const sessionResponse = await fetch(
              `${SERVER_BASE_URL}/api/onboarding/connected-accounts/session`,
              {
                method: 'POST',
                headers: {
                  Authorization: `Bearer ${AUTH_TOKEN}`,
                },
                body: JSON.stringify({}), // Send empty JSON object
              },
            );

            if (!sessionResponse.ok) {
              const errorText = await sessionResponse.text();
              throw new Error(
                `Session refresh failed: ${sessionResponse.status} ${sessionResponse.statusText}. Response: ${errorText}`,
              );
            }

            const sessionData = await sessionResponse.json();
            clientSecret = sessionData.clientSecret;
            console.log('Session refreshed');
          } else {
            // Backend gave us a valid session (new or existing)
            clientSecret = accountData.clientSecret;
            console.log(
              `Using ${accountData.sessionStatus} session from backend`,
            );
          }

          statusEl.textContent = 'Loading Stripe Connect component...';
          statusEl.className = 'status info';

          // Wait for Stripe Connect ES module to load
          const waitForStripeConnect = () => {
            return new Promise((resolve, reject) => {
              if (
                window.stripeConnectReady &&
                window.loadConnectAndInitialize
              ) {
                resolve(window.loadConnectAndInitialize);
                return;
              }

              let attempts = 0;
              const maxAttempts = 20; // 2 seconds max

              const checkInterval = setInterval(() => {
                attempts++;

                if (
                  window.stripeConnectReady &&
                  window.loadConnectAndInitialize
                ) {
                  clearInterval(checkInterval);
                  resolve(window.loadConnectAndInitialize);
                } else if (attempts >= maxAttempts) {
                  clearInterval(checkInterval);
                  const availableGlobals = Object.keys(window).filter(
                    (k) => k.includes('Stripe') || k.includes('loadConnect'),
                  );
                  reject(
                    new Error(
                      `Stripe Connect failed to load. Available: ${availableGlobals.join(', ')}`,
                    ),
                  );
                }
              }, 100);
            });
          };

          console.log('Waiting for Stripe Connect to load...');
          const loadConnectAndInitialize = await waitForStripeConnect();
          console.log('Stripe Connect library loaded successfully');

          // Initialize Stripe Connect with the client secret using the correct API
          // IMPORTANT: Replace this with your actual Stripe publishable key
          const STRIPE_PUBLISHABLE_KEY =
            'pk_test_51DPgutDJLzJ14cfP7t0Ggfwbbf3VMXX7IMIaAnYINI6YXLaHlZx4vg3IPsQDwRcRmTP5jX18BIOAKwHe52BMOzaI00GKLEaMFP';

          if (
            !STRIPE_PUBLISHABLE_KEY ||
            STRIPE_PUBLISHABLE_KEY === 'pk_test_your_publishable_key_here'
          ) {
            throw new Error(
              'Please set your Stripe publishable key in the HTML file',
            );
          }

          console.log('Initializing Stripe Connect with:', {
            publishableKey: STRIPE_PUBLISHABLE_KEY.substring(0, 20) + '...',
            clientSecretLength: clientSecret.length,
            clientSecretPrefix: clientSecret.substring(0, 20) + '...',
          });

          // Keep track of how many times we've refreshed
          let refreshCount = 0;
          const maxRefreshes = 5;

          const stripeConnectInstance = loadConnectAndInitialize({
            publishableKey: STRIPE_PUBLISHABLE_KEY,
            fetchClientSecret: async () => {
              console.log(
                'fetchClientSecret called (refresh count: ' +
                  refreshCount +
                  ')',
              );

              // If this is being called again, it means the session expired
              // Fetch a fresh one from the backend
              if (refreshCount > 0) {
                console.log(
                  'Session expired, fetching new session from backend...',
                );

                if (refreshCount >= maxRefreshes) {
                  throw new Error(
                    'Maximum session refresh attempts reached. Please reload the page.',
                  );
                }

                try {
                  const sessionResponse = await fetch(
                    `${SERVER_BASE_URL}/api/onboarding/connected-accounts/session`,
                    {
                      method: 'POST',
                      headers: {
                        'Content-Type': 'application/json',
                        Authorization: `Bearer ${AUTH_TOKEN}`,
                      },
                      body: JSON.stringify({}),
                    },
                  );

                  if (!sessionResponse.ok) {
                    throw new Error(
                      `Session refresh failed: ${sessionResponse.status}`,
                    );
                  }

                  const sessionData = await sessionResponse.json();
                  clientSecret = sessionData.clientSecret;
                  console.log(
                    'New session fetched:',
                    clientSecret.substring(0, 20) + '...',
                  );
                } catch (error) {
                  console.error('Failed to refresh session:', error);
                  throw error;
                }
              }

              refreshCount++;
              console.log(
                'Returning client secret:',
                clientSecret.substring(0, 20) + '...',
              );
              return clientSecret;
            },
          });

          console.log('Stripe Connect instance:', stripeConnectInstance);
          console.log('Available methods:', Object.keys(stripeConnectInstance));

          // Create onboarding component
          const stripeComponent =
            stripeConnectInstance.create('account-onboarding');
          console.log('Onboarding component:', stripeComponent);
          console.log(
            'Onboarding methods:',
            Object.keys(stripeComponent || {}),
          );

          // Set up error handler for the component
          if (stripeComponent.setOnLoadError) {
            stripeComponent.setOnLoadError((error) => {
              console.error('Stripe component load error:', error);

              // Check if this is a session claim error
              if (
                error.message &&
                error.message.includes('claim account session')
              ) {
                statusEl.textContent =
                  'Session expired. Click "Refresh Session" button or reload the page to get a new session.';
                statusEl.className = 'status error';

                // Show a helpful message
                componentEl.innerHTML = `
                  <div style="padding: 20px; text-align: center;">
                    <p style="color: #dc2626; font-weight: bold; margin-bottom: 10px;">Session Expired</p>
                    <p style="color: #666; margin-bottom: 15px;">
                      The Stripe Connect session has expired (sessions only last 2 minutes in test mode).
                    </p>
                    <button 
                      onclick="refreshSession()" 
                      style="background: #4f46e5; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;"
                    >
                      Get New Session
                    </button>
                  </div>
                `;
              } else {
                statusEl.textContent = `Stripe Error: ${error.message || 'Unknown error'}`;
                statusEl.className = 'status error';
              }
            });
          }

          // Set up exit handler
          if (stripeComponent.setOnExit) {
            stripeComponent.setOnExit(() => {
              console.log('User exited Stripe onboarding');
              statusEl.textContent =
                'Onboarding exited. Please refresh to try again.';
              statusEl.className = 'status info';
            });
          }

          // Mount using appendChild (like in blawby project)
          const containerElement = document.getElementById('connect-component');
          if (containerElement && stripeComponent) {
            containerElement.innerHTML = '';
            containerElement.appendChild(stripeComponent);
            console.log('Stripe component mounted using appendChild');
          } else {
            throw new Error(
              'Could not mount Stripe component - container or component not found',
            );
          }

          // Show the container
          containerEl.classList.remove('hidden');

          statusEl.textContent = 'Stripe Connect loaded successfully!';
          statusEl.className = 'status success';

          console.log(
            'Stripe Connect onboarding component mounted with secret:',
            clientSecret.substring(0, 20) + '...',
          );
        } catch (error) {
          statusEl.textContent = 'Error: ' + error.message;
          statusEl.className = 'status error';
          console.error('Failed to load Stripe Connect:', error);

          componentEl.innerHTML = `<p style="color: red;">Failed to load: ${error.message}</p>`;
        }
      }

      // Refresh session manually - backend handles revocation and storage
      async function refreshSession() {
        const statusEl = document.getElementById('connect-status');
        statusEl.textContent = 'Refreshing session...';
        statusEl.className = 'status info';

        try {
          // Call backend to create new session
          const sessionResponse = await fetch(
            `${SERVER_BASE_URL}/api/onboarding/connected-accounts/session`,
            {
              method: 'POST',
              headers: {
                Authorization: `Bearer ${AUTH_TOKEN}`,
              },
              body: JSON.stringify({}), // Send empty JSON object
            },
          );

          if (!sessionResponse.ok) {
            const errorText = await sessionResponse.text();
            throw new Error(
              `Session refresh failed: ${sessionResponse.status} ${sessionResponse.statusText}. Response: ${errorText}`,
            );
          }

          const sessionData = await sessionResponse.json();

          statusEl.textContent = 'Session refreshed successfully!';
          statusEl.className = 'status success';

          console.log('Session refreshed:', sessionData);
        } catch (error) {
          statusEl.textContent = 'Session refresh failed: ' + error.message;
          statusEl.className = 'status error';
          console.error('Failed to refresh session:', error);
        }
      }
    </script>
  </body>
</html>
