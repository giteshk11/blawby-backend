<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Stripe Components Test</title>
    <script src="https://js.stripe.com/v3/"></script>
    <script src="https://js.stripe.com/connect-js/v1/connect.js"></script>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
          Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: #333;
      }
      .container {
        max-width: 1000px;
        margin: 0 auto;
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .section {
        margin-bottom: 30px;
        padding: 20px;
        border: 1px solid #e1e5e9;
        border-radius: 8px;
      }
      .section h2 {
        color: #4f46e5;
        margin-bottom: 15px;
      }
      .test-button {
        background: #4f46e5;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
        transition: background-color 0.2s;
      }
      .test-button:hover {
        background: #3730a3;
      }
      .status {
        padding: 10px;
        border-radius: 5px;
        margin: 10px 0;
      }
      .success {
        background: #d1fae5;
      }
      .error {
        background: #fecaca;
      }
      .info {
        background: #dbeafe;
      }

      /* Stripe Elements styling */
      .StripeElement {
        background-color: white;
        height: 40px;
        padding: 10px 12px;
        border-radius: 4px;
        border: 1px solid transparent;
        box-shadow: 0 1px 3px 0 #e6ebf1;
        -webkit-transition: box-shadow 150ms ease;
        transition: box-shadow 150ms ease;
      }
      .StripeElement--focus {
        box-shadow: 0 1px 3px 0 #cfd7df;
      }
      .StripeElement--invalid {
        border-color: #fa755a;
      }
      .StripeElement--webkit-autofill {
        background-color: #fefde5 !important;
      }

      #card-element {
        margin: 10px 0;
      }

      .hidden {
        display: none;
      }

      .stripe-connect-container {
        min-height: 400px;
        border: 2px solid #e1e5e9;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
        background: #f9f9f9;
      }

      #connect-component {
        min-height: 300px;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 10px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Stripe Components Test</h1>

      <div class="section">
        <h2>Stripe Connect Account Onboarding</h2>
        <p>Test Stripe's Connect account onboarding component:</p>

        <button class="test-button" onclick="testServerConnection()">
          Test Server Connection
        </button>

        <button class="test-button" onclick="loadStripeConnect()">
          Load Stripe Connect Onboarding
        </button>

        <div id="connect-status" class="status info">Status: Ready to test</div>

        <div
          id="stripe-connect-container"
          class="stripe-connect-container hidden"
        >
          <h3>Stripe Connect Account Onboarding</h3>
          <div id="connect-component"></div>
        </div>
      </div>

      <div class="section">
        <h2>Test Results</h2>
        <div id="results"></div>
      </div>
    </div>

    <script>
      // Server configuration
      const SERVER_BASE_URL = 'http://localhost:3000';

      // Token management
      let AUTH_TOKEN =
        localStorage.getItem('auth_token') ||
        'CwmloD1bXhpDvXk5BTgcx9OShL1I9Y23';

      // Initialize Stripe Connect only
      console.log(
        'Stripe Connect loaded:',
        typeof StripeConnect !== 'undefined',
      );
      console.log('Current auth token:', AUTH_TOKEN.substring(0, 20) + '...');

      // Test server connection
      async function testServerConnection() {
        const statusEl = document.getElementById('connect-status');
        statusEl.textContent = 'Testing server connection...';
        statusEl.className = 'status info';

        try {
          // Test basic server health
          const healthResponse = await fetch(`${SERVER_BASE_URL}/api/health`);
          console.log('Health check response:', healthResponse.status);

          statusEl.textContent = `Server is running! Health check: ${healthResponse.status}`;
          statusEl.className = 'status success';
        } catch (error) {
          statusEl.textContent = 'Server connection failed: ' + error.message;
          statusEl.className = 'status error';
          console.error('Server test error:', error);
        }
      }

      // Load Stripe Connect component with API secret
      async function loadStripeConnect() {
        const statusEl = document.getElementById('connect-status');
        const containerEl = document.getElementById('stripe-connect-container');
        const componentEl = document.getElementById('connect-component');

        statusEl.textContent = 'Creating/getting connected account...';
        statusEl.className = 'status info';

        try {
          // Step 1: Create or get connected account
          const accountResponse = await fetch(
            `${SERVER_BASE_URL}/api/onboarding/connected-accounts`,
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${AUTH_TOKEN}`,
              },
              body: JSON.stringify({
                email: 'test@example.com',
                country: 'US',
              }),
            },
          );

          if (!accountResponse.ok) {
            const errorText = await accountResponse.text();
            throw new Error(
              `Account creation failed: ${accountResponse.status} ${accountResponse.statusText}. Response: ${errorText}`,
            );
          }

          const accountData = await accountResponse.json();
          console.log('Account created/retrieved:', accountData);

          statusEl.textContent = 'Creating onboarding session...';
          statusEl.className = 'status info';

          // Step 2: Create onboarding session
          const sessionResponse = await fetch(
            `${SERVER_BASE_URL}/api/onboarding/connected-accounts/session`,
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
            },
          );

          if (!sessionResponse.ok) {
            const errorText = await sessionResponse.text();
            throw new Error(
              `Session creation failed: ${sessionResponse.status} ${sessionResponse.statusText}. Response: ${errorText}`,
            );
          }

          const sessionData = await sessionResponse.json();
          const clientSecret = sessionData.clientSecret;

          statusEl.textContent = 'Loading Stripe Connect component...';
          statusEl.className = 'status info';

          // Step 3: Load Stripe Connect JS with the real client secret
          const { loadConnectAndInitialize } = StripeConnect;

          const stripeConnect = await loadConnectAndInitialize({
            publishableKey: 'pk_test_your_publishable_key_here', // Replace with your actual key
            fetchClientSecret: async () => clientSecret,
          });

          // Step 4: Create and mount onboarding component
          const onboarding = stripeConnect.create('account-onboarding');
          onboarding.mount('#connect-component');

          // Show the container
          containerEl.classList.remove('hidden');

          statusEl.textContent = 'Stripe Connect loaded successfully!';
          statusEl.className = 'status success';

          console.log('Account data:', accountData);
          console.log('Session data:', sessionData);
          console.log(
            'Stripe Connect onboarding component mounted with secret:',
            clientSecret,
          );
        } catch (error) {
          statusEl.textContent = 'Error: ' + error.message;
          statusEl.className = 'status error';
          console.error('Failed to load Stripe Connect:', error);

          componentEl.innerHTML = `<p style="color: red;">Failed to load: ${error.message}</p>`;
        }
      }
    </script>
  </body>
</html>
